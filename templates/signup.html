<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error_Logging</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>

    <link rel="stylesheet" href="../static/CSS/signup.css">
</head>
<body>

<!--ë©”ì¸ container-->
<main style="display: flex; align-items: center; flex-direction: column; justify-content: center">
    <!-- ìƒë‹¨ ì œëª© container -->
    <div class="container">
        <div class="row" style=" margin:25px auto;">
            <div class="fs-4 text-primary text-center">
                ğŸ”¥íšŒì›ê°€ì…ğŸ”¥
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row form-signin">
            <form>
                <div class="m-2">íšŒì› ì•„ì´ë””</div>
                <div class="input-group mb-3">
                    <input autocomplete="off" id="user_id" type="text" class="form-control" placeholder="íšŒì› ì•„ì´ë””(ê¸€ììˆ˜ 9~12)"
                           aria-label="Recipient's username" aria-describedby="button-addon2">
                    <button class="btn btn-outline-secondary" type="button"
                            id="user_id_duplicate_check">ì¤‘ë³µí™•ì¸
                    </button>
                </div>
                <div class="text-danger fs-6 m-2 " id="user_id_message">

                </div>
                <div class="m-2">íšŒì› ë¹„ë°€ë²ˆí˜¸</div>
                <div class="input-group mb-3">
                    <input id="user_pw" type="password" class="form-control"
                           aria-label="Sizing example input"
                           placeholder="íšŒì› ë¹„ë°€ë²ˆí˜¸ íŠ¹ìˆ˜ë¬¸ì í¬í•¨ 9ìë¦¬ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”"
                           aria-describedby="inputGroup-sizing-default">
                </div>
                <div class="text-danger fs-6 m-2 " id="user_pw_message">

                </div>

                <div class="m-2">íšŒì› ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥</div>
                <div class="input-group mb-3">
                    <input id="user_pw_check" type="password" class="form-control" aria-label="Sizing example input"
                           placeholder="íšŒì› ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš” "
                           aria-describedby="inputGroup-sizing-default">
                </div>
                <div class="text-danger fs-6 m-2 " id="user_pw_check_message">

                </div>

                <div class="m-2">íšŒì› ë‹‰ë„¤ì„</div>
                <div class="input-group mb-3">
                    <input autocomplete="off" id="user_nickname" type="text" class="form-control" placeholder="ë‹‰ë„¤ì„(ê¸€ììˆ˜ 2~10)"
                           aria-label="Recipient's username" aria-describedby="button-addon2">
                    <button class="btn btn-outline-secondary" type="button" id="user_nickname_duplicate_check">ì¤‘ë³µí™•ì¸
                    </button>
                </div>
                <div class="text-danger fs-6 m-2 " id="user_nickname_message">

                </div>

                <button onclick="user_signup()" class="mt-3 w-100 btn btn-lg btn-primary" type="button">íšŒì›ê°€ì…</button>
            </form>
        </div>
    </div>


</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
<script>
    let id_check = false, nick_check = false;

    // ì¤‘ë³µì²´í¬ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ ë˜ëŠ” í•¨ìˆ˜
    $('#user_id_duplicate_check').click(function () {
        user_id_check()
    })

    // ë¹„ë°€ë²ˆí˜¸ ë‹¤ ì…ë ¥í•˜ê³  focus out í•  ê²½ìš° ì‹¤í–‰ ë˜ëŠ” í•¨ìˆ˜
    $('#user_pw').focusout(function () {
        user_pw_check()
    })

    // ë¹„ë°€ë²ˆí˜¸ ë‹¤ ì…ë ¥í•˜ê³  focus out í•  ê²½ìš° ì‹¤í–‰ ë˜ëŠ” í•¨ìˆ˜
    $('#user_pw_check').focusout(function () {
        user_pw_again_check()
    })

    $('#user_nickname_duplicate_check').click(function () {
        user_nickname_check()
    })

    //íšŒì› ì•„ì´ë”” ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
    //TO-DO Ajax ì´ìš©í•´ì„œ, ì•„ì´ë”” ì¤‘ë³µ check ì•„ì§ ë¯¸êµ¬í˜„
    function user_id_check() {

        let user_id = $('#user_id').val()
        // ìš°ì„  ì¤‘ë³µ check ajaxë¡œ DB ì—°ê²°í•´ì„œ ì•ˆê²¹ì¹˜ëŠ”ê±° í™•ì¸í•œ í›„ , ê·¸ ë’¤ì— ìœ íš¨ì„± ê²€ì‚¬
        let formData = new FormData();
        // ìš°ì„  ì¤‘ë³µ check ajaxë¡œ DB ì—°ê²°í•´ì„œ ë‹‰ë„¤ì„ ì•ˆê²¹ì¹˜ëŠ”ê±° í™•ì¸í•œ í›„ , ê·¸ ë’¤ì— ìœ íš¨ì„± ê²€ì‚¬
        formData.append('check_item', "user_id")
        formData.append('check_value', user_id)
        $.ajax({
            type: "POST",
            url: "/check/duplicate",
            data: formData,
            contentType: false,
            processData: false,
            success: function (response) {
                if (response['result'] == 'success') {
                    //ì •ê·œì‹ì„ í™œìš©í•´ì„œ íŠ¹ìˆ˜ë¬¸ì or ê³µë°± ê±°ë¥´ëŠ” IFë¬¸
                    if (user_id.search(/\W|\s/g) > -1) {
                        validation_false("user_id_message", "ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ ì•„ì´ë”” ì…ë‹ˆë‹¤.")
                        return false;
                    } else {
                        //ì‚¬ìš©ì íŠ¹ìˆ˜ë¬¸ì ê¸¸ì´ í™•ì¸í•˜ëŠ” IFë¬¸
                        if (user_id.length >= 6 && user_id.length <= 12) {
                            validation_true("user_id_message", "ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë”” ì…ë‹ˆë‹¤.")
                            return true;
                        } else {
                            validation_false("user_id_message", "ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ ì•„ì´ë”” ì…ë‹ˆë‹¤.")
                            return false;
                        }
                    }
                } else {
                    validation_false("user_id_message", "ì¤‘ë³µëœ ì•„ì´ë”” ì…ë‹ˆë‹¤.")
                    return false;
                }
            }
        })


    }

    //íšŒì› ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
    function user_pw_check() {
        let user_pw = $('#user_pw').val()
        // ì‚¬ìš©ì ê¸¸ì´ 6~20  , íŠ¹ë¬¸ or ìˆ«ì1ê°œ ë°˜ë“œì‹œ í¬í•¨
        if (user_pw.search(/^(?=.*[a-zA-Z])((?=.*\d)|(?=.*\W)).{6,20}$/) > -1) {
            validation_true("user_pw_message", "ì‚¬ìš© ê°€ëŠ¥í•œ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.")
            return true
        } else {
            validation_false("user_pw_message", "ìµœì†Œ 1ê°œì˜ ìˆ«ì í˜¹ì€ íŠ¹ìˆ˜ ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•¨ ê¸¸ì´ (6~20) ")
            return false
        }
    }

    //íšŒì› ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì‚¬ í•¨ìˆ˜
    function user_pw_again_check() {
        let user_pw_again = $('#user_pw_check').val()
        let user_pw = $('#user_pw').val()
        if (user_pw === user_pw_again) {
            validation_true("user_pw_check_message", "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.")
            return true
        } else {
            validation_false("user_pw_check_message", "ë¹„ë°€ë²ˆí˜¸ê°€ ë‹¤ë¦…ë‹ˆë‹¤.")
            return false
        }
    }

    //ë‹‰ë„¤ì„ ì¤‘ë³µ ë° ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
    //TO-DO Ajax ì´ìš©í•´ì„œ, ì•„ì´ë”” ì¤‘ë³µ check ì•„ì§ ë¯¸êµ¬í˜„
    function user_nickname_check() {

        const regex = /^[ã„±-ã…|ê°€-í£|a-z|A-Z|0-9|]+$/;

        let formData = new FormData();
        let user_nickname = $('#user_nickname').val()
        // ìš°ì„  ì¤‘ë³µ check ajaxë¡œ DB ì—°ê²°í•´ì„œ ë‹‰ë„¤ì„ ì•ˆê²¹ì¹˜ëŠ”ê±° í™•ì¸í•œ í›„ , ê·¸ ë’¤ì— ìœ íš¨ì„± ê²€ì‚¬
        formData.append('check_item', "user_nickname")
        formData.append('check_value', user_nickname)
        $.ajax({
            type: "POST",
            url: "/check/duplicate",
            data: formData,
            contentType: false,
            processData: false,
            success: function (response) {

                if (response['result'] == 'success') {
                    if (regex.test(user_nickname) === false) {
                        validation_false("user_nickname_message", "ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ ë‹‰ë„¤ì„ ì…ë‹ˆë‹¤.")
                        return false;
                    } else {
                        if (user_nickname.length >= 2 && user_nickname.length <= 10) {
                            validation_true("user_nickname_message", "ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ ì…ë‹ˆë‹¤.")
                            return true;
                        } else {
                            validation_false("user_nickname_message", "ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ ë‹‰ë„¤ì„ ì…ë‹ˆë‹¤.")
                            return false;
                        }
                    }
                } else {
                    validation_false("user_nickname_message", "ì¤‘ë³µëœ ë‹‰ë„¤ì„ ì…ë‹ˆë‹¤.")
                    return false;

                }

            }
        })


    }


    // ìœ íš¨ì„± ê²€ì‚¬ í›„ ê° div idì— ì‘ì„±ë  message ì‘ì„±
    function validation_true(id, message) {
        $('#' + id).removeClass('text-danger')
        $('#' + id).addClass('text-primary')
        $('#' + id).text(message)
        if (id === "user_id_message") {
            id_check = true
        } else if (id === "user_nickname_message") {
            nick_check = true
        }
    }

    function validation_false(id, message) {
        $('#' + id).removeClass('text-primary')
        $('#' + id).addClass('text-danger')
        $('#' + id).text(message)
        if (id === "user_id_message") {
            id_check = false
        } else if (id === "user_nickname_message") {
            nick_check = false
        }

    }


    function user_signup() {
        if (user_id_check() === false) {
            alert("idë¥¼ í™•ì¸í•˜ì„¸ìš”")
            validation_false("user_id_message", "ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ ì•„ì´ë”” ì…ë‹ˆë‹¤.")
            return;
        } else if (user_pw_check() === false) {
            alert("pwë¥¼ í™•ì¸í•˜ì„¸ìš”")
            validation_false("user_pw_message", "ìµœì†Œ 1ê°œì˜ ìˆ«ì í˜¹ì€ íŠ¹ìˆ˜ ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•¨ ê¸¸ì´ (6~20) ")
            return;

        } else if (user_pw_again_check() === false) {
            alert("pwë¥¼ í™•ì¸í•˜ì„¸ìš”")
            validation_false("user_pw_check_message", "ë¹„ë°€ë²ˆí˜¸ê°€ ë‹¤ë¦…ë‹ˆë‹¤.")
            return;
        } else if (user_nickname_check() === false) {
            alert("ë‹‰ë„¤ì„ì„ í™•ì¸í•˜ì„¸ìš”")
            validation_false("user_nickname_message", "ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ ë‹‰ë„¤ì„ ì…ë‹ˆë‹¤.")
            return false;
        }
        // ë‹¤ í†µê³¼í–ˆìœ¼ë©´ ì„œë²„ë¡œ ì „ì†¡
        else {
            setTimeout(() => {
                if (nick_check === true && id_check === true) {
                    let formData = new FormData();
                    let user_id = $('#user_id').val()
                    let user_pw = $('#user_pw').val()
                    let user_nickname = $('#user_nickname').val()
                    // ìš°ì„  ì¤‘ë³µ check ajaxë¡œ DB ì—°ê²°í•´ì„œ ë‹‰ë„¤ì„ ì•ˆê²¹ì¹˜ëŠ”ê±° í™•ì¸í•œ í›„ , ê·¸ ë’¤ì— ìœ íš¨ì„± ê²€ì‚¬
                    formData.append('user_pw', user_pw)
                    formData.append('user_id', user_id)
                    formData.append('user_nickname', user_nickname)
                    $.ajax({
                        type: "POST",
                        url: "/log/signup/verify",
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: function (response) {
                            if (response['result'] == 'success') {
                                $.cookie('user_token',response['token'],{path:'/'})
                                window.location.replace('/')
                                alert("íšŒì›ê°€ì… ì„±ê³µ")
                            }


                        }
                    })
                } else {
                    alert("íšŒì›ì •ë³´ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”")
                }

            }, 1000)


        }

    }
</script>
</body>
</html>